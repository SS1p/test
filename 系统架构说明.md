# 文件变动自动监测与解析系统 - 架构说明

## 系统概述

本系统实现了**完整的文件变动监测与自动解析解决方案**，包含：
- 持续监控data目录的文件变动
- 自动触发文件解析流程
- WebSocket实时通知前端
- 手动触发解析功能
- 完整的日志记录

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Browser)                       │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  index.html  │  │  detail.html │  │   ws-client.js   │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
│         │                 │                   │             │
│  ┌──────────────┐  ┌──────────────┐           │             │
│  │    app.js    │  │  detail.js   │◄──────────┘             │
│  └──────────────┘  └──────────────┘                         │
│         │                 │                                 │
│         └─────────────────┘                                 │
│                   │                                         │
│              WebSocket连接                                  │
│                   │                                         │
└───────────────────┼─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    服务层 (Node.js)                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    server.js                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │   │
│  │  │ FileWatcher  │  │ WebSocketMgr │  │FileParser │ │   │
│  │  │   (chokidar) │  │     (ws)     │  │  (xlsx)   │ │   │
│  │  └──────────────┘  └──────────────┘  └───────────┘ │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Express HTTP Server (Port 3000)         │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │/api/... │ │/api/... │ │/api/... │ │ static  │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Winston Logger (logs/)                  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层 (Data)                           │
├─────────────────────────────────────────────────────────────┤
│  data/                                                      │
│  ├── 总体得分表_20260216_114402.xlsx                        │
│  ├── {单位}__{网站}__OK__{code}.xlsx  (详情文件)            │
│  ├── file_list.json          (自动生成的文件列表)           │
│  ├── mapping_report.json     (自动生成的映射报告)           │
│  └── mapping_report.txt      (文本格式映射报告)             │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. FileWatcher (文件监控器)

**功能：**
- 使用 `chokidar` 库持续监控 `data/` 目录
- 检测文件创建、修改、删除事件
- 防抖处理（1秒延迟）避免频繁触发
- 等待文件写入完成后再触发解析

**事件类型：**
- `add` - 新文件创建
- `change` - 文件修改
- `unlink` - 文件删除

### 2. FileParser (文件解析器)

**功能：**
- 解析文件名格式：`{单位}__{网站}__{状态}__{标识}.xlsx`
- 扫描目录建立文件映射
- 解析Excel文件内容
- 生成 `file_list.json` 和 `mapping_report.json`

### 3. WebSocketManager (WebSocket管理器)


**功能：**
- 管理客户端连接
- 广播解析状态通知
- 处理客户端手动扫描请求
- 自动重连机制

**消息类型：**
- `connected` - 连接成功
- `parseStart` - 开始解析
- `parseComplete` - 解析完成
- `parseError` - 解析错误
- `requestScan` - 手动扫描请求

### 4. WebSocketClient (前端客户端)

**功能：**
- 自动连接WebSocket服务器
- 接收服务器通知
- 显示实时通知和加载状态
- 自动重连机制
- 触发页面数据刷新

## 工作流程

### 自动监测流程

```
1. 文件变动检测
   │
   ▼
2. FileWatcher.detectChange()
   │
   ▼
3. 防抖处理 (1秒延迟)
   │
   ▼
4. triggerParse('add|change|unlink', filename)
   │
   ▼
5. 广播 parseStart 消息
   │
   ▼
6. FileParser.scanFiles()
   │
   ├─ 扫描目录
   ├─ 解析文件名
   ├─ 生成 file_list.json
   └─ 生成 mapping_report.json
   │
   ▼
7. 广播 parseComplete 消息
   │
   ▼
8. 前端接收通知，自动刷新数据
```

### 手动触发流程

```
1. 用户点击"刷新"按钮
   │
   ▼
2. manualRefresh()
   │
   ▼
3. wsClient.requestScan()
   │
   ▼
4. WebSocket发送 requestScan 消息
   │
   ▼
5. 服务器触发 triggerParse('manual')
   │
   ▼
6. 执行解析流程...
   │
   ▼
7. 广播结果到所有客户端
```

## API接口

### HTTP API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/files` | 获取文件列表 |
| GET | `/api/mapping` | 获取映射报告 |
| POST | `/api/scan` | 手动触发扫描 |
| GET | `/api/status` | 获取系统状态 |
| GET | `/api/logs?limit=100` | 获取日志 |

### WebSocket消息

**服务器→客户端：**

```json
{
  "type": "parseStart",
  "triggerType": "add",
  "filename": "xxx.xlsx",
  "timestamp": "2026-02-25 17:30:00",
  "message": "正在处理文件: xxx.xlsx"
}
```

```json
{
  "type": "parseComplete",
  "triggerType": "add",
  "timestamp": "2026-02-25 17:30:01",
  "duration": 500,
  "summary": {
    "totalFiles": 25,
    "detailFiles": 24,
    "overallFile": 1
  },
  "message": "解析完成，共 25 个文件，耗时 500ms"
}
```

**客户端→服务器：**

```json
{
  "type": "requestScan"
}
```

## 使用说明

### 启动服务

```bash
# 安装依赖
npm install

# 启动服务
node server.js

# 或使用nodemon（开发模式）
npm run dev
```

服务启动后：
- HTTP服务器运行在 http://localhost:3000
- WebSocket服务运行在 ws://localhost:3000
- 日志保存在 `logs/` 目录

### 添加新文件

1. 将Excel文件放入 `data/` 目录
2. 系统自动检测变动并解析
3. 前端自动收到通知并刷新

### 手动触发解析

**方式1：点击页面"刷新"按钮**

**方式2：调用API**
```bash
curl -X POST http://localhost:3000/api/scan
```

**方式3：通过WebSocket**
```javascript
wsClient.requestScan();
```

## 日志记录

日志文件保存在 `logs/` 目录：
- `combined.log` - 所有日志
- `error.log` - 错误日志

日志格式：
```
[2026-02-25 17:29:10] [INFO]: 开始扫描文件...
[2026-02-25 17:29:10] [INFO]: 文件扫描完成，共 24 个文件，耗时 22ms
```

## 配置项

在 `server.js` 中修改：

```javascript
const CONFIG = {
    PORT: 3000,                    // HTTP端口
    DATA_DIR: './data',            // 数据目录
    LOG_DIR: './logs',             // 日志目录
    DEBOUNCE_DELAY: 1000,          // 防抖延迟（毫秒）
    SUPPORTED_EXTENSIONS: ['.xlsx'] // 支持的文件扩展名
};
```

## 故障排除

### WebSocket连接失败

1. 检查Node.js服务是否运行
2. 检查防火墙设置
3. 查看浏览器控制台错误信息

### 文件变动未检测

1. 检查文件是否在 `data/` 目录
2. 检查文件扩展名是否为 `.xlsx`
3. 查看 `logs/combined.log` 日志

### 解析失败

1. 检查Excel文件格式是否正确
2. 查看 `logs/error.log` 错误日志
3. 检查文件名格式是否符合规范

## 性能优化

- **防抖处理**：避免大文件复制时的频繁触发
- **队列机制**：解析任务排队执行，避免并发
- **文件写入等待**：等待文件完全写入后再解析
- **增量更新**：只重新加载变动的数据

## 安全考虑

- 只监控指定的 `data/` 目录
- 忽略隐藏文件（以`.`开头的文件）
- 只处理 `.xlsx` 扩展名的文件
- 等待文件写入完成后再解析
